---
- name: Get Disk Usage and Transfer to SFTP
  hosts: all
  vars:
    sftp_host: "dmnetcloud"
    sftp_port: "2022"
    sftp_user: "dharmesh"
    sftp_password: "Thankgod@123"
    local_output_file: "/tmp/disk_usage.txt"
    remote_path: "/imp/sfs_ansible/disk_usage.txt"  # File destination on SFTP

  tasks:
    - name: Ensure duf is installed
      become: yes  # Keep sudo for package installation
      apt:
        name: duf
        state: present

    - name: Get disk usage information with duf
      command: duf
      register: duf_output

    - name: Save disk usage information to a local file
      copy:
        content: "{{ duf_output.stdout }}"
        dest: "{{ local_output_file }}"

    - name: Transfer disk usage file to SFTP server
      delegate_to: localhost  # Ensure it's run from Ansible control node
      become: no  # Disable sudo
      shell: "sshpass -p '{{ sftp_password }}' sftp -o StrictHostKeyChecking=no -P {{ sftp_port }} {{ sftp_user }}@{{ sftp_host }} <<< $'put {{ local_output_file }} {{ remote_path }}'"

    - name: Remove the local disk usage file after transfer
      become: no  # Disable sudo
      file:
        path: "{{ local_output_file }}"
        state: absent

    - name: Display completion message
      debug:
        msg: "Disk usage report successfully uploaded to SFTP!"
